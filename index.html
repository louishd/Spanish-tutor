function loopVAD() {
  // iPhone: si on n'est pas en mode hands-free, ou si l'IA parle, on attend
  if (!useHandsFree || !vadEnabled || ttsSpeaking) {
    setTimeout(loopVAD, VAD.tickMs);
    return;
  }

  const speaking = rmsLevel() > VAD.threshold;

  if (!isRecording) {
    silenceMs = speaking ? silenceMs + VAD.tickMs : 0;
    if (silenceMs >= VAD.startMs) {
      silenceMs = 0;
      startAutoRecording();
    }
  } else {
    silenceMs = !speaking ? silenceMs + VAD.tickMs : 0;
    if (silenceMs >= VAD.stopMs) {
      silenceMs = 0;
      stopAutoRecordingAndSend().catch(console.error);
    }
  }

  setTimeout(loopVAD, VAD.tickMs);
}
